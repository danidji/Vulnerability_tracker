from flask import Flask , render_template , request

from data import add_data, create_table, get_data
from services import get_errors, prettier_data

app = Flask(__name__)


# home route
@app.route("/")
def home(): 
    create_table()
    return render_template('index.html')

# GET and POST request 
@app.route("/api/vulnerabilities", methods=['GET','POST'])
def handle_data():
    if request.method == 'POST': 
        data = request.json
        my_errors= {
            "errors" : get_errors(data)
        }
        if len(my_errors["errors"]) != 0:
            return my_errors

        else:
            new_vulnerability = prettier_data(data)
            add_data(new_vulnerability)
            data = get_data()

            # handling case where the database is empty
            if len(data) == 0: 
                my_data = {
                        'vulnerability' : []
                    }
            else: 
                my_data = {
                    'vulnerability' : data[-1] # get the last element solved
                }
            return my_data
            
    elif request.method == 'GET' : 
        my_data = {
                    'vulnerabilities' : get_data() 
                }
        return my_data